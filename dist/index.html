<!DOCTYPE html>
<html>
<body>
  <progress max="100" value="0"></progress>
  <button class="download">download</button>
  <script>
    const $$ = (selecor, parent = document) => [...parent.querySelectorAll(selecor)];
    function fetchDL() {
      const pgbar = $$('progress')[0];
      pgbar.value = 0;
      fetch('/download')
        .then(response => {
          pgbar.max = Number(response.headers.get('Content-Length'));
          const reader = response.body.getReader();
          function read({ done, value }) {
            if (done) {
              return 'done';
            }
            pgbar.value += value.length;
            return reader.read().then(read);
          }
          return reader.read().then(read);
          // new Response(stream, { headers: { "Content-Type": "text/plain" } });
        })
        .then(result => {
          console.log(result);
        });
    }
    document.addEventListener('DOMContentLoaded', () => {
      $$('.download')[0].addEventListener('click', fetchDL);
    });
  </script>
</body>
</html>
